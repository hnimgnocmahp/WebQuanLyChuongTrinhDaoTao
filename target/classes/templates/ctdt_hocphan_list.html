<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Học Phần</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-…"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <!-- Navbar -->
    <div th:replace="fragments :: navbar"></div>

    <div class="container mt-4">
      <h1 class="mb-4">Danh sách Học Phần</h1>
      <a
        th:href="@{/ctdt_hocphan/new}"
        class="btn btn-primary float-end mb-3 me-3"
        >Thêm mới</a
      >
      <table class="table table-striped table-bordered table-hover">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Mã HP</th>
            <th>Tên HP</th>
            <th>Số TC</th>
            <th>Số tiết LT</th>
            <th>Số tiết TH</th>
            <th>Nhóm ID</th>
            <th>Loại HP</th>
            <th>HP Tiên quyết</th>
            <th>Hành động</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="item : ${ctdt_hocphan}">
            <td th:text="${item.id}"></td>
            <td th:text="${item.maHp}"></td>
            <td th:text="${item.tenHp}"></td>
            <td th:text="${item.soTinChi}"></td>
            <td th:text="${item.soTietLyThuyet}"></td>
            <td th:text="${item.soTietThucHanh}"></td>
            <td th:text="${item.nhomId}"></td>
            <td th:text="${item.loaiHp}"></td>
            <td th:text="${item.hocPhanTienQuyet}"></td>
            <td>
              <a
                th:href="@{|/ctdt_hocphan/edit/${item.id}|}"
                class="btn btn-sm btn-warning"
                >Sửa</a
              >
              <a
                th:href="@{|/ctdt_hocphan/delete/${item.id}|}"
                class="btn btn-sm btn-danger"
                onclick="return confirm('Xác nhận xóa?');"
                >Xóa</a
              >
              <a
                class="btn btn-sm btn-info"
                href="#"
                th:attr="data-bs-toggle='modal',data-bs-target='#deCuongModal'"
                th:onclick="'showDeCuongChiTiet(' + ${item.id} + ')'"
                >Chi tiết</a
              >
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-…"
      crossorigin="anonymous"
    ></script>

    <!-- Modal hiển thị đề cương chi tiết -->
    <div
      class="modal fade"
      id="deCuongModal"
      tabindex="-1"
      aria-labelledby="deCuongModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deCuongModalLabel">
              Đề cương chi tiết
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Đóng"
            ></button>
          </div>
          <div class="modal-body">
            <table class="table" style="min-width: 1100px">
              <thead>
                <tr>
                  <th style="width: 150px">Mục tiêu</th>
                  <th style="width: 300px">Nội dung</th>
                  <th style="width: 200px">Phương pháp giảng dạy</th>
                  <th style="width: 150px">Tên cột điểm</th>
                  <th style="width: 150px">Tỷ lệ phần trăm</th>
                  <th style="width: 150px">Hình thức</th>
                </tr>
              </thead>
              <tbody id="cotDiemBody">
                <tr>
                  <td id="mucTieuCell" rowspan="1"></td>
                  <td id="noiDungCell" rowspan="1"></td>
                  <td id="phuongPhapCell" rowspan="1"></td>
                  <td id="tenCotDiemCell"></td>
                  <td id="tyLePhanTramCell"></td>
                  <td id="hinhThucCell"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      function showDeCuongChiTiet(hocPhanId) {
        fetch("/decuong/" + hocPhanId)
          .then((response) => {
            if (!response.ok) throw new Error("Không tìm thấy dữ liệu!");
            return response.json();
          })
          .then((data) => {
            // Lấy tbody để render các dòng cột điểm
            const cotDiemBody = document.getElementById("cotDiemBody");
            cotDiemBody.innerHTML = "";
            const cotDiemList = data.cot_diem || [];
            if (cotDiemList.length === 0) {
              // Nếu không có cột điểm, chỉ hiển thị 1 dòng mục tiêu, nội dung, phương pháp
              const row = document.createElement("tr");
              row.innerHTML = `
                <td id='mucTieuCell'>${data.muc_tieu || ""}</td>
                <td id='noiDungCell'>${data.noi_dung || ""}</td>
                <td id='phuongPhapCell'>${data.phuong_phap_giang_day || ""}</td>
                <td colspan='3' class='text-center'>Không có dữ liệu cột điểm</td>
              `;
              cotDiemBody.appendChild(row);
            } else {
              cotDiemList.forEach((cotDiem, idx) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td ${
                    idx === 0
                      ? `rowspan='${cotDiemList.length}' id='mucTieuCell'`
                      : "style='display:none'"
                  }>${idx === 0 ? data.muc_tieu || "" : ""}</td>
                  <td ${
                    idx === 0
                      ? `rowspan='${cotDiemList.length}' id='noiDungCell'`
                      : "style='display:none'"
                  }>${idx === 0 ? data.noi_dung || "" : ""}</td>
                  <td ${
                    idx === 0
                      ? `rowspan='${cotDiemList.length}' id='phuongPhapCell'`
                      : "style='display:none'"
                  }>${idx === 0 ? data.phuong_phap_giang_day || "" : ""}</td>
                  <td>${cotDiem.tenCotDiem || ""}</td>
                  <td>${cotDiem.tyLePhanTram || ""}</td>
                  <td>${cotDiem.hinhThuc || ""}</td>
                `;
                cotDiemBody.appendChild(row);
              });
            }
          })
          .catch((error) => {
            const cotDiemBody = document.getElementById("cotDiemBody");
            cotDiemBody.innerHTML = "";
            const row = document.createElement("tr");
            row.innerHTML = `
              <td id='mucTieuCell'></td>
              <td id='noiDungCell'></td>
              <td id='phuongPhapCell'></td>
              <td colspan='3' class='text-center'>${error.message}</td>
            `;
            cotDiemBody.appendChild(row);
          });
      }
    </script>
  </body>
</html>
